FROM python:3.12-slim

ENV TZ=Asia/Karachi
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Force use of HTTPS for package sources
RUN sed -i 's/http:/https:/g' /etc/apt/sources.list && \
    sed -i 's/http:/https:/g' /etc/apt/sources.list.d/*.list 2>/dev/null || true && \
    apt-get update -o Acquire::ForceIPv4=true && \
    apt-get install -y --no-install-recommends \
        ca-certificates tzdata build-essential libpq-dev gettext \
        libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0 \
        libffi-dev shared-mime-info && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Set timezone
RUN ln -fs /usr/share/zoneinfo/$TZ /etc/localtime && dpkg-reconfigure -f noninteractive tzdata

WORKDIR /usr/src/app

COPY requirements.txt /usr/src/app/
RUN pip install --no-cache-dir -r requirements.txt

COPY . /usr/src/app

RUN mkdir -p /usr/src/app/staticfiles \
    && chmod -R 755 /usr/src/app/staticfiles

EXPOSE 80

CMD ["bash", "./runserver.sh"]